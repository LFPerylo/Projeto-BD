<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Cadastro de Or√ßamento / Contrato</title>
    <link rel="stylesheet" href="/style.css">
    <script>
        let orcamentos = [], clientes = [], funcionarios = [], temas = [];

        async function carregarDropdowns() {
            [clientes, funcionarios, temas] = await Promise.all([
                fetch("/clientes").then(r => r.json()),
                fetch("/funcionarios").then(r => r.json()),
                fetch("/temas").then(r => r.json())
            ]);
            const sel = id => document.getElementById(id);
            sel("codCliente").innerHTML = "<option value=''>Selecione</option>";
            sel("codFuncionario").innerHTML = "<option value=''>Selecione</option>";
            sel("codTema").innerHTML = "<option value=''>Selecione</option>";
            clientes.forEach(c => {
                const o = new Option(c.nome, c.codCliente);
                sel("codCliente").append(o);
            });
            funcionarios.forEach(f => {
                const o = new Option(f.nome, f.codFuncionario);
                sel("codFuncionario").append(o);
            });
            temas.forEach(t => {
                const o = new Option(t.nome, t.codTema);
                sel("codTema").append(o);
            });
        }

        async function listarOrcamentos() {
            orcamentos = await fetch("/orcamentos").then(r => r.json());
            const tbody = document.getElementById("orcamentos-tbody");
            tbody.innerHTML = "";
            orcamentos.forEach(o => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
          <td>${o.codOrcamento}</td>
          <td>${o.numContrato || "-"}</td>
          <td>R$ ${o.valorInicial?.toFixed(2)||"0,00"}</td>
          <td>R$ ${o.valorSinal?.toFixed(2)||"0,00"}</td>
          <td>${o.codCliente}</td>
          <td>${o.dataAssinatura||"-"}</td>
          <td></td>
        `;
                const td = tr.lastElementChild;
                const btnE = document.createElement("button");
                btnE.textContent = "Editar";
                btnE.addEventListener("click", ()=> editarOrcamento(o));
                const btnD = document.createElement("button");
                btnD.textContent = "Excluir";
                btnD.addEventListener("click", async ()=>{
                    await fetch(`/orcamentos/${o.codOrcamento}/${o.numContrato}`, {method:"DELETE"});
                    await listarOrcamentos();
                });
                td.append(btnE, btnD);
                tbody.append(tr);
            });
        }

        function editarOrcamento(o) {
            document.getElementById("codOrcamento").value   = o.codOrcamento;
            document.getElementById("numContrato").value    = o.numContrato || "";
            document.getElementById("codCliente").value     = o.codCliente;
            document.getElementById("codFuncionario").value = o.codFuncionario;
            document.getElementById("codTema").value        = o.codTema;
            document.getElementById("dataFesta").value      = o.dataFesta;
            document.getElementById("horarioFesta").value   = o.horarioFesta;
            document.getElementById("valorInicial").value   = o.valorInicial;
            document.getElementById("localFesta").value     = o.localFesta || "";
            document.getElementById("diaSemana").value      = o.diaSemana || "";
            document.getElementById("dataAssinatura").value = o.dataAssinatura || "";
            document.getElementById("valorSinal").value     = o.valorSinal || "";
        }

        async function salvarOrcamento(evt) {
            evt.preventDefault();
            const f = document.getElementById("form-orcamento");
            const o = {
                codOrcamento:   f.codOrcamento.value||null,
                numContrato:    f.numContrato.value||null,
                codCliente:     +f.codCliente.value,
                codFuncionario: +f.codFuncionario.value,
                codTema:        +f.codTema.value,
                dataFesta:      f.dataFesta.value,
                horarioFesta:   f.horarioFesta.value,
                valorInicial:   parseFloat(f.valorInicial.value),
                localFesta:     f.localFesta.value,
                diaSemana:      f.diaSemana.value,
                dataAssinatura: f.dataAssinatura.value||null,
                valorSinal:     parseFloat(f.valorSinal.value)||0
            };
            const isEdit = !!o.codOrcamento;
            const url = isEdit
                ? `/orcamentos/${o.codOrcamento}/${o.numContrato}`
                : "/orcamentos";
            const method = isEdit ? "PUT" : "POST";
            await fetch(url, {
                method,
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify(o)
            });
            f.reset();
            await listarOrcamentos();
        }

        function filtrarOrcamentos() {
            const q = document.getElementById("filtroOrcamento").value.toLowerCase();
            document.querySelectorAll("#orcamentos-tbody tr").forEach(tr=>{
                const cod  = tr.children[0].textContent.toLowerCase();
                const numC = tr.children[1].textContent.toLowerCase();
                tr.style.display = (cod.includes(q)||numC.includes(q))?"":"none";
            });
        }

        window.onload = async ()=>{
            await carregarDropdowns();
            await listarOrcamentos();
            fetch("/sidebar.html").then(r=>r.text()).then(html=>{
                document.getElementById("sidebar-container").innerHTML = html;
            });
        };
    </script>
</head>
<body>
<div id="sidebar-container"></div>
<div class="main-content">
    <h1>Cadastro de Or√ßamento / Contrato</h1>
    <form id="form-orcamento" onsubmit="salvarOrcamento(event)">
        <input type="hidden" id="codOrcamento" name="codOrcamento">
        <label>Contrato N¬∫:</label>
        <input type="text" id="numContrato" name="numContrato">
        <label>Cliente:</label>
        <select id="codCliente" name="codCliente" required></select>
        <label>Funcion√°rio:</label>
        <select id="codFuncionario" name="codFuncionario" required></select>
        <label>Tema:</label>
        <select id="codTema" name="codTema" required></select>
        <label>Data da Festa:</label>
        <input type="date" id="dataFesta" name="dataFesta" required>
        <label>Hor√°rio da Festa:</label>
        <input type="time" id="horarioFesta" name="horarioFesta" required>
        <label>Valor Inicial:</label>
        <input type="number" id="valorInicial" name="valorInicial" step="0.01" required>
        <label>Local da Festa:</label>
        <input type="text" id="localFesta" name="localFesta">
        <label>Dia da Semana:</label>
        <input type="text" id="diaSemana" name="diaSemana">
        <label>Data da Assinatura:</label>
        <input type="date" id="dataAssinatura" name="dataAssinatura">
        <label>Valor do Sinal:</label>
        <input type="number" id="valorSinal" name="valorSinal" step="0.01">
        <button type="submit">Salvar</button>
    </form>
    <h2>Lista de Or√ßamentos</h2>
    <input type="text" id="filtroOrcamento" class="barra-pesquisa"
           placeholder="üîç Buscar c√≥digo ou contrato..." oninput="filtrarOrcamentos()">
    <table>
        <thead>
        <tr>
            <th>C√≥digo</th><th>Contrato N¬∫</th><th>Valor Inicial</th>
            <th>Valor do Sinal</th><th>Cliente</th><th>Data Assinatura</th><th>A√ß√µes</th>
        </tr>
        </thead>
        <tbody id="orcamentos-tbody"></tbody>
    </table>
</div>
</body>
</html>
