<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Início</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
<div id="sidebar-container"></div>

<div class="main-content">
  <h1>DashBoards</h1>

  <div class="card-container">
    <div class="card resumo-card">Total de Clientes: <span id="card-clientes">-</span></div>
    <div class="card resumo-card">Faturamento no Mês: <span id="card-faturamento">-</span></div>
    <div class="card resumo-card">Festas no Mês: <span id="card-festas">-</span></div>
  </div>


  <section id="dashboard">
    <h2> Temas Mais Utilizados</h2>
    <canvas id="grafico-temas" width="600" height="300"></canvas>
  </section>

  <section id="aniversariantes-proximos">
    <h2> Aniversariantes nos Próximos 45 Dias</h2>
    <canvas id="grafico-aniversariantes" width="600" height="300"></canvas>
  </section>

  <section id="resumo-financeiro">
    <h2>📋 Resumo Financeiro do Contrato</h2>

    <div class="resumo-card">
      <div class="resumo-input">
        <input type="number" id="contrato-numero" placeholder="Número do Contrato">
        <button onclick="carregarResumoContrato()">Ver Resumo</button>
      </div>

      <div id="resumo-result" class="resumo-detalhes" style="display: none;">
        <p><strong>Valor Inicial:</strong> R$ <span id="valor-inicial"></span></p>
        <p><strong>Valor do Sinal:</strong> R$ <span id="valor-sinal"></span></p>
        <p><strong>Valor Acrescentado:</strong> R$ <span id="valor-extra"></span></p>
        <p><strong>Valor Final:</strong> R$ <span id="valor-final"></span></p>
      </div>

      <div id="resumo-erro" class="erro-mensagem" style="display: none;">
        <p>❌ Resumo não encontrado.</p>
      </div>
    </div>
  </section>

  <section id="dashboard-festas">
    <h2>📅 Festas por Mês</h2>

    <div class="filtro-dashboard">
      <input type="number" id="input-ano" placeholder="Ano (ex: 2025)" class="input-ano">
      <button onclick="carregarGraficoFestasPorMes()">Ver Gráfico</button>
    </div>

    <div class="grafico-container">
      <canvas id="grafico-festas"></canvas>
    </div>
  </section>


</div>

<script>
  // Carregar a sidebar externa
  fetch("/sidebar.html")
          .then(res => res.text())
          .then(html => document.getElementById("sidebar-container").innerHTML = html);

  fetch("/footer.html")
          .then(res => res.text())
          .then(html => document.getElementById("footer-container").innerHTML = html);

  // Carregar gráfico de temas
  async function carregarGraficoTemas() {
    try {
      const response = await fetch("/temas/mais-usados");
      if (!response.ok) throw new Error("Erro ao buscar dados do gráfico");

      const dados = (await response.json())
              .filter(d => d.quantidade > 0)
              .sort((a, b) => b.quantidade - a.quantidade)
              .slice(0, 5);

      const nomes = dados.map(d => d.tema);
      const quantidades = dados.map(d => d.quantidade);

      new Chart(document.getElementById("grafico-temas"), {
        type: 'bar',
        data: {
          labels: nomes,
          datasets: [{
            label: 'Temas mais utilizados',
            data: quantidades,
            backgroundColor: '#a267d0'
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                precision: 0,
                callback: function(value) {
                  return Number.isInteger(value) ? value : null;
                }
              }
            }
          }
        }
      });
    } catch (erro) {
      console.error("Erro ao carregar gráfico:", erro);
    }
  }

  // Gráfico de aniversariantes (nome + código)
  async function carregarGraficoAniversariantes() {
    try {
      const response = await fetch("/festas/aniversariantes/proximos");
      if (!response.ok) throw new Error("Erro ao buscar aniversariantes");

      const dados = await response.json();

      const labels = dados.map(p => `${p.cod_aniversariante} - ${p.nome}`);
      const diasRestantes = dados.map(p => p.dias_restantes);

      new Chart(document.getElementById("grafico-aniversariantes"), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Dias restantes para o aniversário',
            data: diasRestantes,
            backgroundColor: '#d08aa2'
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                precision: 0,
                callback: function (value) {
                  return Number.isInteger(value) ? value : null;
                }
              }
            }
          }
        }
      });
    } catch (erro) {
      console.error("Erro ao carregar gráfico de aniversariantes:", erro);
    }
  }

  async function carregarResumoContrato() {
    const contrato = document.getElementById("contrato-numero").value;
    if (!contrato) return alert("Informe o número do contrato.");

    try {
      const response = await fetch(`/pagamentos/resumo-financeiro/${contrato}`);
      if (!response.ok) throw new Error("Resumo não encontrado.");

      const resumo = await response.json();

      document.getElementById("valor-inicial").innerText = `R$ ${resumo.valor_inicial.toFixed(2)}`;
      document.getElementById("valor-sinal").innerText = `R$ ${resumo.valor_sinal.toFixed(2)}`;
      document.getElementById("valor-extra").innerText = `R$ ${resumo.valor_extra.toFixed(2)}`;
      document.getElementById("valor-final").innerText =
              resumo.valor_final !== null
                      ? `R$ ${resumo.valor_final.toFixed(2)}`
                      : "Ainda não foi pago";

      document.getElementById("resumo-result").style.display = "block";
      document.getElementById("resumo-erro").style.display = "none";
    } catch (erro) {
      console.error("Erro ao carregar resumo:", erro);
      document.getElementById("resumo-result").style.display = "none";
      document.getElementById("resumo-erro").style.display = "block";
    }
  }

  async function carregarGraficoFestasPorMes() {
    const anoInput = document.getElementById("input-ano").value;
    const ano = anoInput ? parseInt(anoInput) : new Date().getFullYear();

    try {
      const response = await fetch(`/orcamentos/por-mes/${ano}`);
      if (!response.ok) throw new Error("Erro na requisição");

      const dados = await response.json();
      if (!Array.isArray(dados)) throw new Error("Resposta inválida");

      const labels = dados.map(d => `Mês ${d.mes}`);
      const valores = dados.map(d => d.quantidade);

      const graficoAnterior = Chart.getChart("grafico-festas");
      if (graficoAnterior) graficoAnterior.destroy();

      new Chart(document.getElementById("grafico-festas"), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: `Festas no ano ${ano}`,
            data: valores,
            backgroundColor: '#7e57c2'
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                precision: 0
              }
            }
          }
        }
      });
    } catch (error) {
      console.error("Erro ao carregar gráfico:", error);
      alert("Erro ao carregar festas. Verifique se o ano é válido ou se o servidor está rodando.");
    }
  }

  async function carregarResumoDashboard() {
    try {
      const res = await fetch("/dashboard/resumo");
      const dados = await res.json();

      document.getElementById("card-clientes").innerText =
              dados.totalClientes != null ? dados.totalClientes : "-";
      document.getElementById("card-faturamento").innerText =
              dados.faturamentoMesAtual != null ? "R$ " + dados.faturamentoMesAtual.toFixed(2) : "R$ 0,00";
      document.getElementById("card-festas").innerText =
              dados.festasMesAtual != null ? dados.festasMesAtual : "-";
    } catch (erro) {
      console.error("Erro ao carregar dashboard:", erro);
    }
  }

  // Ao carregar a página
  window.onload = () => {
    carregarGraficoTemas();
    carregarGraficoAniversariantes();
    carregarGraficoFestasPorMes();
    carregarResumoDashboard()
  };
</script>


</body>
</html>
