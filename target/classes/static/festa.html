<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cadastro de Festa</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    /* Remove setinhas dos inputs tipo number */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type=number] {
      -moz-appearance: textfield;
    }

    .barra-pesquisa {
      width: 100%;
      padding: 8px;
      margin: 12px 0;
      box-sizing: border-box;
    }
  </style>
  <script>
    let festas = [];
    let contratos = [];
    let temas = [];
    let aniversariantes = [];

    async function carregarDropdowns() {
      contratos = await fetch("/orcamentos").then(r => r.json());
      temas = await fetch("/temas").then(r => r.json());

      const contratoSelect = document.getElementById("numContrato");
      const temaSelect = document.getElementById("codTema");

      contratoSelect.innerHTML = "<option value=''>Selecione</option>";
      temaSelect.innerHTML = "<option value=''>Selecione</option>";

      contratos.forEach(c => {
        if (c.numContrato) {
          const opt = document.createElement("option");
          opt.value = c.numContrato;
          opt.textContent = `Contrato N췈 ${c.numContrato}`;
          contratoSelect.appendChild(opt);
        }
      });

      temas.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.codTema;
        opt.textContent = t.nome;
        temaSelect.appendChild(opt);
      });
    }

    async function listarFestas() {
      festas = await fetch("/festas").then(r => r.json());
      const tbody = document.getElementById("festas-tbody");
      tbody.innerHTML = "";

      festas.forEach(f => {
        const contrato = contratos.find(c => c.numContrato == f.numContrato);
        const tema = temas.find(t => t.codTema === f.codTema);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${f.codFesta}</td>
          <td>${contrato ? contrato.numContrato : '-'}</td>
          <td>${tema ? tema.nome : '-'}</td>
          <td>${f.horarioFim}</td>
          <td></td>
        `;

        const botoesTd = tr.querySelector("td:last-child");

        const editarBtn = document.createElement("button");
        editarBtn.innerText = "Editar";
        editarBtn.onclick = () => editarFesta(f.codFesta);

        const excluirBtn = document.createElement("button");
        excluirBtn.innerText = "Excluir";
        excluirBtn.onclick = async () => {
          await fetch(`/festas/${f.codFesta}`, { method: "DELETE" });
          listarFestas();
        };

        botoesTd.appendChild(editarBtn);
        botoesTd.appendChild(excluirBtn);
        tbody.appendChild(tr);
      });
    }

    function adicionarAniversariante() {
      const nome = document.getElementById("nomeAniversariante").value.trim();
      const idade = parseInt(document.getElementById("idadeAniversariante").value);
      const dataNascimento = document.getElementById("dataNascimentoAniversariante").value;

      if (!nome || !idade || !dataNascimento) {
        alert("Preencha todos os campos do aniversariante.");
        return;
      }

      aniversariantes.push({ nome, idade, dataNascimento });

      const li = document.createElement("li");
      li.textContent = `${nome} (${idade} anos) - ${dataNascimento}`;
      document.getElementById("aniversariantes-lista").appendChild(li);

      document.getElementById("nomeAniversariante").value = "";
      document.getElementById("idadeAniversariante").value = "";
      document.getElementById("dataNascimentoAniversariante").value = "";
    }

    async function salvarFesta(event) {
      event.preventDefault();

      if (aniversariantes.length === 0) {
        alert("Adicione pelo menos um aniversariante.");
        return;
      }

      const ano = parseInt(document.getElementById("anoFesta").value);
      if (!ano || ano < 1900) {
        alert("Informe um ano v치lido para a realiza칞칚o da festa.");
        return;
      }

      const festaPayload = {
        festa: {
          codFesta: document.getElementById("codFesta").value || null,
          numContrato: document.getElementById("numContrato").value,
          codTema: parseInt(document.getElementById("codTema").value),
          horarioFim: document.getElementById("horarioFim").value
        },
        aniversariantes: aniversariantes,
        ano: ano
      };

      const method = festaPayload.festa.codFesta ? "PUT" : "POST";
      const url = festaPayload.festa.codFesta
              ? `/festas/${festaPayload.festa.codFesta}`
              : "/festas";

      await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(festaPayload)
      });

      document.getElementById("form-festa").reset();
      document.getElementById("aniversariantes-lista").innerHTML = "";
      aniversariantes = [];

      listarFestas();
    }

    function editarFesta(id) {
      const f = festas.find(f => f.codFesta === id);
      document.getElementById("codFesta").value = f.codFesta;
      document.getElementById("numContrato").value = f.numContrato;
      document.getElementById("codTema").value = f.codTema;
      document.getElementById("horarioFim").value = f.horarioFim;
    }

    function filtrarFestas() {
      const filtro = document.getElementById("filtroFesta").value.toLowerCase();
      const linhas = document.querySelectorAll("#festas-tbody tr");

      linhas.forEach(linha => {
        const cod = linha.children[0].textContent.toLowerCase();
        const contrato = linha.children[1].textContent.toLowerCase();
        const tema = linha.children[2].textContent.toLowerCase();

        linha.style.display =
                cod.includes(filtro) || contrato.includes(filtro) || tema.includes(filtro)
                        ? ""
                        : "none";
      });
    }

    window.onload = async () => {
      await carregarDropdowns();
      await listarFestas();

      fetch("/sidebar.html")
              .then(res => res.text())
              .then(html => document.getElementById("sidebar-container").innerHTML = html);
    };
  </script>
</head>
<body>
<div id="sidebar-container"></div>

<div class="main-content">
  <h1>Cadastro de Festa</h1>
  <form id="form-festa" onsubmit="salvarFesta(event)">
    <input type="hidden" id="codFesta">

    <label>Contrato:</label>
    <select id="numContrato" required></select>

    <label>Tema:</label>
    <select id="codTema" required></select>

    <label>Hor치rio de Fim:</label>
    <input type="time" id="horarioFim" required>

    <label>Ano da Festa:</label>
    <input type="number" id="anoFesta" placeholder="Ex: 2022" required>

    <h3>Aniversariantes</h3>
    <input type="text" id="nomeAniversariante" placeholder="Nome">
    <input type="number" id="idadeAniversariante" placeholder="Idade">
    <input type="date" id="dataNascimentoAniversariante">
    <button type="button" onclick="adicionarAniversariante()">Adicionar Aniversariante</button>

    <ul id="aniversariantes-lista"></ul>

    <button type="submit">Salvar Festa</button>
  </form>

  <h2>Lista de Festas</h2>

  <input type="text" id="filtroFesta" placeholder="游댌 Buscar por c칩digo, contrato ou tema..." oninput="filtrarFestas()" class="barra-pesquisa">

  <table>
    <thead>
    <tr>
      <th>C칩digo</th>
      <th>Contrato</th>
      <th>Tema</th>
      <th>Hor치rio Fim</th>
      <th>A칞칫es</th>
    </tr>
    </thead>
    <tbody id="festas-tbody"></tbody>
  </table>
</div>
</body>
</html>
